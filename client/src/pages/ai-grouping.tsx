import { AIGroupingPanel } from '@/components/ai-grouping-panel';\nimport { RequirementsTable } from '@/components/requirements-table';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Button } from '@/components/ui/button';\nimport { Separator } from '@/components/ui/separator';\nimport { Brain, Users, TrendingUp, CheckCircle, Settings } from 'lucide-react';\nimport { useState } from 'react';\nimport type { RequirementGroup, Requirement } from '@shared/schema';\n\nexport function AIGroupingPage() {\n  const [isProcessing, setIsProcessing] = useState(false);\n  const [progress, setProgress] = useState(0);\n  const [suggestedGroups, setSuggestedGroups] = useState<RequirementGroup[]>([]);\n  const [appliedGroups, setAppliedGroups] = useState<RequirementGroup[]>([]);\n\n  // Mock data for preview\n  const mockPreviewRequirements: Requirement[] = [\n    {\n      id: 'req-001',\n      text: 'Systemet ska stödja inloggning med tvåfaktorsautentisering',\n      occurrences: 1,\n      organizations: ['Test Org'],\n      must_count: 1,\n      should_count: 0,\n      fulfilled_yes: 0,\n      fulfilled_no: 0,\n      attachment_required: false,\n      req_ids: ['req-001'],\n      categories: ['Säkerhet'],\n      procurements: ['P2024-01'],\n      dates: ['2024-03-01'],\n      sample_comment: '',\n      sample_response: '',\n      user_comment: '',\n      user_status: 'OK',\n      group_id: 'auth-group-1',\n      group_representative: true,\n      similarity_score: 95,\n      historical_comments: [],\n      last_seen_date: '2024-03-01',\n      first_seen_date: '2024-03-01',\n      is_new: true,\n      category_label: 'Säkerhet',\n      import_organization: 'Test Org',\n      import_date: '2024-03-01',\n      requirement_type: 'Skall',\n      requirement_category: 'Säkerhet'\n    },\n    {\n      id: 'req-002',\n      text: '2FA ska implementeras för alla användarkonton',\n      occurrences: 1,\n      organizations: ['Test Org'],\n      must_count: 1,\n      should_count: 0,\n      fulfilled_yes: 0,\n      fulfilled_no: 0,\n      attachment_required: false,\n      req_ids: ['req-002'],\n      categories: ['Säkerhet'],\n      procurements: ['P2024-01'],\n      dates: ['2024-03-01'],\n      sample_comment: '',\n      sample_response: '',\n      user_comment: '',\n      user_status: 'OK',\n      group_id: 'auth-group-1',\n      group_representative: false,\n      similarity_score: 95,\n      historical_comments: [],\n      last_seen_date: '2024-03-01',\n      first_seen_date: '2024-03-01',\n      is_new: true,\n      category_label: 'Säkerhet',\n      import_organization: 'Test Org',\n      import_date: '2024-03-01',\n      requirement_type: 'Skall',\n      requirement_category: 'Säkerhet'\n    }\n  ];\n\n  const mockGroups: RequirementGroup[] = [\n    {\n      groupId: 'auth-group-1',\n      representativeId: 'req-001',\n      members: ['req-001', 'req-002', 'req-045'],\n      similarityScore: 95,\n      category: 'Säkerhet och autentisering'\n    },\n    {\n      groupId: 'backup-group-1',\n      representativeId: 'req-078',\n      members: ['req-078', 'req-134'],\n      similarityScore: 87,\n      category: 'Backup och återställning'\n    },\n    {\n      groupId: 'api-group-1',\n      representativeId: 'req-156',\n      members: ['req-156', 'req-203', 'req-267', 'req-289'],\n      similarityScore: 92,\n      category: 'API och integration'\n    },\n    {\n      groupId: 'gdpr-group-1',\n      representativeId: 'req-301',\n      members: ['req-301', 'req-334'],\n      similarityScore: 73,\n      category: 'GDPR och personuppgifter'\n    }\n  ];\n\n  const totalRequirements = 1247;\n  const currentGroups = appliedGroups.length;\n  const potentialSavings = suggestedGroups.reduce((sum, group) => sum + (group.members.length - 1), 0);\n\n  const handleStartGrouping = () => {\n    console.log('Starting AI grouping...');\n    setIsProcessing(true);\n    setProgress(0);\n    setSuggestedGroups([]);\n    \n    // Simulate AI processing\n    const interval = setInterval(() => {\n      setProgress(prev => {\n        if (prev >= 100) {\n          clearInterval(interval);\n          setIsProcessing(false);\n          setSuggestedGroups(mockGroups);\n          return 100;\n        }\n        return prev + Math.random() * 10;\n      });\n    }, 200);\n  };\n\n  const handleAcceptGrouping = (groups: RequirementGroup[]) => {\n    console.log('Accepting groups:', groups);\n    setAppliedGroups(prev => [...prev, ...groups]);\n    setSuggestedGroups(prev => prev.filter(g => !groups.find(accepted => accepted.groupId === g.groupId)));\n  };\n\n  const handleConfigureAI = () => {\n    console.log('Configure AI settings');\n  };\n\n  return (\n    <div className=\"p-6 max-w-7xl mx-auto space-y-8\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">AI Kravgruppering</h1>\n          <p className=\"text-muted-foreground mt-1\">\n            Använd artificiell intelligens för att automatiskt gruppera liknande krav.\n          </p>\n        </div>\n        \n        <Button\n          variant=\"outline\"\n          onClick={handleConfigureAI}\n          className=\"gap-2\"\n          data-testid=\"button-configure-ai\"\n        >\n          <Settings className=\"h-4 w-4\" />\n          AI-inställningar\n        </Button>\n      </div>\n\n      {/* Overview Stats */}\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Totalt krav</CardTitle>\n            <Brain className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"stat-total-requirements\">\n              {totalRequirements.toLocaleString('sv-SE')}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              I systemet\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Aktiva grupper</CardTitle>\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"stat-current-groups\">\n              {currentGroups}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Applicerade grupperingar\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Potentiell besparing</CardTitle>\n            <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-green-600\" data-testid=\"stat-potential-savings\">\n              {potentialSavings}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Mindre krav att hantera\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Föreslagna grupper</CardTitle>\n            <CheckCircle className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-blue-600\" data-testid=\"stat-suggested-groups\">\n              {suggestedGroups.length}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Väntar på granskning\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* AI Grouping Panel */}\n      <AIGroupingPanel\n        onStartGrouping={handleStartGrouping}\n        onAcceptGrouping={handleAcceptGrouping}\n        isProcessing={isProcessing}\n        progress={progress}\n        suggestedGroups={suggestedGroups}\n        totalRequirements={totalRequirements}\n      />\n\n      {/* Applied Groups Summary */}\n      {appliedGroups.length > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <CheckCircle className=\"h-5 w-5 text-green-600\" />\n              Applicerade grupperingar\n            </CardTitle>\n            <CardDescription>\n              {appliedGroups.length} grupper har applicerats på dina krav.\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-3\">\n              {appliedGroups.map((group) => (\n                <div key={group.groupId} className=\"flex items-center justify-between p-3 bg-green-50 dark:bg-green-950 rounded-lg border border-green-200 dark:border-green-800\">\n                  <div className=\"flex items-center gap-3\">\n                    <Users className=\"h-4 w-4 text-green-600\" />\n                    <div>\n                      <span className=\"font-medium\">Grupp {group.groupId}</span>\n                      {group.category && (\n                        <Badge variant=\"outline\" className=\"ml-2 text-xs\">\n                          {group.category}\n                        </Badge>\n                      )}\n                      <p className=\"text-sm text-muted-foreground\">\n                        {group.members.length} krav • {group.similarityScore}% likhet\n                      </p>\n                    </div>\n                  </div>\n                  <CheckCircle className=\"h-5 w-5 text-green-600\" />\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Preview Section */}\n      {(appliedGroups.length > 0 || suggestedGroups.length > 0) && (\n        <div className=\"space-y-4\">\n          <div className=\"flex items-center justify-between\">\n            <h2 className=\"text-xl font-semibold\">Förhandsgranskning</h2>\n            <Badge variant=\"outline\">\n              Exempel på grupperade krav\n            </Badge>\n          </div>\n          \n          <RequirementsTable\n            requirements={mockPreviewRequirements}\n            showGrouped={true}\n            onUpdateComment={(id, comment) => console.log('Update comment:', id, comment)}\n            onUpdateStatus={(id, status) => console.log('Update status:', id, status)}\n          />\n        </div>\n      )}\n\n      {/* Help Section */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Hur fungerar AI-gruppering?</CardTitle>\n          <CardDescription>\n            Förstå hur systemet använder artificiell intelligens för att gruppera dina krav.\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6 text-sm\">\n            <div className=\"space-y-3\">\n              <h4 className=\"font-medium\">Analysprocess:</h4>\n              <ul className=\"text-muted-foreground space-y-1 ml-4\">\n                <li>• Textanalys med NLP (Natural Language Processing)</li>\n                <li>• Semantisk likhetsbedömning mellan krav</li>\n                <li>• Kategorisering baserat på innehåll och kontext</li>\n                <li>• Svensk språkhantering med åäö-normalisering</li>\n              </ul>\n            </div>\n            \n            <div className=\"space-y-3\">\n              <h4 className=\"font-medium\">Kvalitetskontroll:</h4>\n              <ul className=\"text-muted-foreground space-y-1 ml-4\">\n                <li>• Likhetspoäng från 0-100% för varje gruppering</li>\n                <li>• Manuell granskning rekommenderas för <90% likhet</li>\n                <li>• Möjlighet att acceptera eller förkasta förslag</li>\n                <li>• Historik sparas för framtida förbättringar</li>\n              </ul>\n            </div>\n            \n            <div className=\"space-y-3\">\n              <h4 className=\"font-medium\">Fördelar:</h4>\n              <ul className=\"text-muted-foreground space-y-1 ml-4\">\n                <li>• Minskar dubbelarbete vid kravhantering</li>\n                <li>• Identifierar samband mellan liknande krav</li>\n                <li>• Standardiserar svar över organisationer</li>\n                <li>• Sparar tid vid upphandlingsprocessen</li>\n              </ul>\n            </div>\n            \n            <div className=\"space-y-3\">\n              <h4 className=\"font-medium\">Begränsningar:</h4>\n              <ul className=\"text-muted-foreground space-y-1 ml-4\">\n                <li>• AI kan missa subtila skillnader i kravtexter</li>\n                <li>• Manuell granskning alltid rekommenderad</li>\n                <li>• Bäst resultat med välstrukturerade kravtexter</li>\n                <li>• Kontinuerlig förbättring genom användarfeedback</li>\n              </ul>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nexport default AIGroupingPage;